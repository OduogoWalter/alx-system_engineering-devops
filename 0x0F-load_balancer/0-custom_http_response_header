#!/usr/bin/env bash

# Bash script to configure Nginx and transfer necessary files from web-01 to web-02

# Function to display usage message
usage() {
  echo "Usage: $0 SSH_PRIVATE_KEY"
  echo "Example: $0 /path/to/private_key"
  exit 1
}

# Check if correct number of arguments are provided
if [ "$#" -ne 1 ]; then
  usage
fi

# Assign arguments to variables
SSH_PRIVATE_KEY="$1"
WEB_01_IP="54.87.238.72"
WEB_02_IP="100.26.56.201"
USERNAME="ubuntu"
NGINX_CONF="/etc/nginx/nginx.conf"

# Transfer nginx configuration from web-01 to web-02
echo "Transferring nginx configuration file from web-01 to web-02..."
./0-transfer_file /etc/nginx/nginx.conf "$WEB_01_IP" "$USERNAME" "$SSH_PRIVATE_KEY" >/dev/null 2>&1

# Update nginx configuration on web-02 to include custom header
echo "Updating nginx configuration on web-02..."
scp -o StrictHostKeyChecking=no -i "$SSH_PRIVATE_KEY" ubuntu@"$WEB_02_IP":~/nginx.conf /tmp/nginx.conf
sed -i 's/# server_tokens off;/server_tokens off;\n\tadd_header X-Served-By $hostname;/' /tmp/nginx.conf

# Transfer modified nginx configuration back to web-02
echo "Transferring modified nginx configuration file to web-02..."
scp -o StrictHostKeyChecking=no -i "$SSH_PRIVATE_KEY" /tmp/nginx.conf ubuntu@"$WEB_02_IP":~/nginx.conf >/dev/null 2>&1

# Restart Nginx on web-02 to apply changes
echo "Restarting Nginx on web-02..."
ssh -o StrictHostKeyChecking=no -i "$SSH_PRIVATE_KEY" ubuntu@"$WEB_02_IP" 'sudo systemctl restart nginx' >/dev/null 2>&1

echo "Configuration completed successfully."
